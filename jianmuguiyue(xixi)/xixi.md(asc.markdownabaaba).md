# HPL与HPCG基准测试及其优化
## 2.1 HPL
### 2.1.1软件环境

- 操作系统：Debian 6.1.90-1 (2024-05-03) x86_64
- 编译器：gcc （Debian 12.2.0-14）12.2.0
- 数学库：MKL 2025
- MPI软件：Open MPI
- 软件版本：HPL-2.3

### 2.1.2测试方法

    使用利用mpi的四十个进程进行测试。

### 2.1.3性能优化方法

1. **HPL配置文件调整：**

```   
loHPLinpack benchmark input file
Innovative Computing Laboratory, University of Tennessee
HPL.out      output file name (if any)
6            device out (6=stdout,7=stderr,file)
1            # of problems sizes (N)
3000          Ns
1            # of NBs
256          NBs
0            PMAP process mapping (0=Row-,1=Column-major)
1            # of process grids (P x Q)
1            Ps
1            Qs
16.0         threshold
3            # of panel fact
0 1 2        PFACTs (0=left, 1=Crout, 2=Right)
2            # of recursive stopping criterium
2 4            NBMINs (>= 1)
1            # of panels in recursion
2            NDIVs
3            # of recursive panel fact.
0 1 2        RFACTs (0=left, 1=Crout, 2=Right)
1            # of broadcast
0            BCASTs (0=1rg,1=1rM,2=2rg,3=2rM,4=Lng,5=LnM)
1            # of lookahead depth
0            DEPTHs (>=0)
2            SWAP (0=bin-exch,1=long,2=mix)
64           swapping threshold
0            L1 in (0=transposed,1=no-transposed) form
0            U  in (0=transposed,1=no-transposed) form
1            Equilibration (0=no,1=yes)
8            memory alignment in double (> 0)
```

1. **第三方库的选择：**
   
     经过测试，我们选择了Openmpi＋MKL的组合。

2. **进程与核心的对应关系：**
           
        每个核心对应一个进程。由于CPU利用率高，难以利用超线程技术。关闭超线程是更好的选择。

### 2.1.4性能评估

核心数：40
每个核心每周期浮点运算次数：14
CPU频率：2.5GHz

- 性能的理论峰值：2.5GHz×14×40 = 1400 Gflops

### 2.1.5问题与解决方案分析

#### 二维处理网格P×Q的选择 

- HPL硬性规定P×Q=进程数量，进程数不能小于P×Q但是在进程数目大于P×Q的时候程序可以正常运行。并且在进程数等于或远大于P×Q的时Gflop可以获得较好的结果
- P×Q越大，所用时间就越长。Gflop结果与P×Q大小有很大的关系，当P×Q=1的时候，Gflop可以获得较为好的结果。
- P×Q以及其他参数相同的情况下，P与Q越接近，Gflop数值越高。
- 对于相同的P×Q,相同的数组调换位置有时可以获得更好的Gflop结果。

#### 矩阵大小n与内存的关系

- 矩阵的大小N越大，有效计算的比例就越高，系统的浮点处理性能也就越高,同时随着N的增大,Gflop也会随之增大；但同时，矩阵的大小N会导
致内存消耗的增加，一旦内存不足，缓存的使用，性能将会大大降低。一般来说，矩阵占用系统总内存的80%左右是最好的，也就是说，N×N×8=总系统内存×80%。

#### 矩阵块大小NB的选择

- NB不也能太大或太小,经过测试,NB等于256的时候可以获得更好的Gflop。随着NB的增大，所用时间整体成减小趋势。
        
#### hpl优化中NB变化对Gflop和Time的影响

|    |测试一|测试二|测试三|测试四|测试五|测试六|测试七|测试八|测试九|
|-------|------|------|------|------|------|------|------|------|------|
|NB|1|32|64|128|256|300|512|600|756|
|Gflop|1.110223e-16| 5.9299e+01|  7.0785e+01|  8.2073e+01| 9.9273e+01|7.6624e+01|5.8845e+01|    7.3717e+01|6.1409e+01|
|Time|0.89|71.99|42.96|32.14|27.57|20.64|18.17|15.9|21.49|17.63|14.39|


#### hpl优化中PQ对Gflop和Time的影响

||测试一|测试二|测试三|测试四|测试五|测试六|测试七|测试八|测试九|
|---------|------|------|------|------|------|------|------|------|------|
|P|1|2|5|4|4|5|5|8|1|
|Q|1|5|2|4|5|4|8|5|40|
|P*Q|1|10|10|16|20|20|40|40|40|
|Gflop|9.9273e+01|1.6 or9.9e+00|  1.0816e+00|  1.1089e+00|  1.3993e+00|  9.1504e-01|  7.3953e-01|  6.9906e-01|  6.2829e+00|
|Time|0.23|1.75|15.42|14.12|10.39|17.85|20.58|22.8|2.49|

带"or"的结果是测试时出现了两个截然不同的结果

#### hpl优化中P*Q和运行进程对Gflop的影响

|    |测试一|测试二|测试三|测试四|测试五|测试六|
|-------|------|------|------|------|------|------|
|进程|40|40|40|20|20|20|
|P*Q|1|20|40|1|10|20|
|Gflop|  8.5346e+01| 1.4378e+00|8.2073e+01| 9.3412e+01|  4.9923e+00| 1.3463e+00|

### hpl优化中N对Gflop的影响

## 2.2 HPCG

### 2.2.1软件环境

- 操作系统：Debian 6.1.90-1 (2024-05-03) x86_64
- 编译器：gcc （Debian 12.2.0-14）12.2.0
- 数学库：MKL 2025
- MPI软件：Open MPI
- 软件版本：HPCG-release-3-1-0

### 2.2.2测试方法

     使用利用mpi的四十个进程进行测试。

### 2.2.3HPCG基准输入文件

     HPCG benchmark input file
     Sandia National Laboratories; University of Tennessee, Knoxville
     64 64 64
     1800

### 2.2.4性能评估

     HPL测试更多地测试超级计算机处理器的理论性能，而HPCG更注重实际性能，对内存系统和网络延迟的要求也更高，因此任何HPC超级计算机测量的HPCG性能都比Linpack低得多。由于我们使用的HPCG测试环境与HPL测试环境相同，这里使用HPCG/HPL比率来衡量计算效率。

### 2.2.5问题和解决方案分析 

#### 进程数量对结果的影响 

- 经过多组数据测试后，我们认为进程数量的选择会大程度地影响结果。
- 并不是所有进程数都是被允许的，对于有些问题规模，一些进程数不能完成任务。
- 进程数=npx×npy×npz（处理器尺寸），对于任意大小的问题规模和进程数，nx（本地域维度）=nx（全局问题维度）/npx（处理器尺寸）ny（本地域维度）=ny（全局问题维度）/npy（处理器尺寸）nz（本地域维度）=nz（全局问题维度）/npz（处理器尺寸），以上的xyz皆为整数。我们认为在某种条件下某些进程数不能满足上述条件导致任务失败。
- 在可行范围内，选择较大的进程数一般会得到更好的结果。

#### 问全局问题维度对结果的影响

- 如果不在文件中特殊标明全局问题维度大小，就会自动分配全局问题维度。
- 自己选择的不同的全局问题维度大小对Gflop的影响不大，由本地域维度=全局问题维度/处理器尺寸可知相应变化的处理器尺寸也对Gflop的影响不大。

#### 本地问题维度的选择 

- 本地域维度的选择对结果影响有限。

#### 运行时间的选择

- HPCG的默认运行时间是60秒，官方最小运行时间为1800秒。经过多组测试后，选择发现大于1800秒的运行时间对结果无太大影响，但1800秒耗时短，故1800秒是最佳的运行时间。

#### 不同参数情况下Gflop的变化  

|进程数量|1|8|15|16|16|40|40|40|
|------|------|------|------|------|------|------|------|------|
|本地域维度|256 256 256|256 256 256|128 128 128|128 128 128|104 104 104|64 256 128|64 64 64|128 128 128|
|全局问题维度|256 256 256|512 512 512|384 640 128|512 256 256|416 208 208|128 102 640|128 256 320|256 512 640|
|Gflop|1.47616|8.21566|5.85121|5.53991|4.96085|9.45033|9.72438|9.47389|      

